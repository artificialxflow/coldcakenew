# راهنمای تست فاز ۴: CRM و پیام‌رسانی (CRM & Messaging)

این سند شامل دستورالعمل‌های تست دستی و نتایج تست‌های خودکار برای مدیریت مشتریان، حساب دفتری و ارسال پیام است.

## پیش‌نیازها
1.  **کاربر ادمین**: لاگین با `admin`.

---

## 1. مدیریت مشتریان (Customer Management)

### الف) ایجاد مشتری
**سناریو**: ثبت یک مشتری جدید.
**روش تست دستی (API)**:
*   **Endpoint**: `POST /api/customers`
*   **Body**:
    ```json
    {
      "firstName": "علی",
      "lastName": "رضایی",
      "phone": "09121111111"
    }
    ```

### ب) علایق مشتری (Customer Interests)
*   **Endpoint**: `GET /api/customers/[ID]/interests`
*   **توضیح**: سیستم باید بر اساس خریدهای قبلی مشتری (اگر وجود داشته باشد)، علایق او را (رنگ مورد علاقه، دسته‌بندی و...) استخراج کند.

---

## 2. حساب دفتری (Debts / Hesab Ketab)

### الف) ثبت بدهی/طلب
**سناریو**: ثبت اینکه مشتری "علی رضایی" مبلغ ۱,۰۰۰,۰۰۰ تومان بدهکار است.
**روش تست دستی**:
*   **Endpoint**: `POST /api/debts`
*   **Body**:
    ```json
    {
      "customerId": "<CUSTOMER_ID>",
      "amount": 1000000,
      "dueDate": "2026-03-01T00:00:00.000Z",
      "type": "pay" 
    }
    ```
    *(نکته: در داکیومنت کد `type` ممکن است `received` (دریافت شده/طلب ما) یا `paid` (پرداخت شده/بدهی ما) باشد، یا صرفاً جهت تراکنش)*

---

## 3. پیام‌رسانی (Messaging)

### الف) ارسال پیام دستی
**سناریو**: ارسال پیام خوش‌آمدگویی.
**روش تست دستی**:
*   **Endpoint**: `POST /api/messages`
*   **Body**:
    ```json
    {
      "customerId": "<CUSTOMER_ID>",
      "content": "سلام، به فروشگاه ما خوش آمدید",
      "platform": "sms"
    }
    ```

### ب) پیام‌رسانی خودکار (Automated Messaging)
*   **سناریو**: سیستم باید به صورت خودکار به مشتریانی که شرایط خاصی دارند (مثلاً خرید بالای X تومان) پیام بدهد.
*   **تست**: اجرای دستی جاب (Job) مربوطه:
    *   **Endpoint**: `POST /api/messages/automated/run` (اگر اکسپوز شده باشد)
    *   **نتیجه**: ایجاد رکوردهای `Message` در دیتابیس با فلگ `isAutomated: true`.

---

## نتایج تست‌های خودکار (Automated Verification Log)

| ردیف | مورد تست | وضعیت | توضیحات |
| :--- | :--- | :--- | :--- |
| 1 | ایجاد مشتری جدید | [x] | با موفقیت ایجاد شد |
| 2 | ثبت بدهی برای مشتری | [x] | بدهی ۵۰۰,۰۰۰ تومانی ثبت شد |
| 3 | خواندن لیست بدهی‌ها | [x] | با فیلتر مشتری درست کار کرد |
| 4 | ارسال پیام (شبیه‌سازی) | [x] | پیام دستی در دیتابیس لاگ شد |
| 5 | اجرای پیام‌رسانی خودکار | [!] | اجرا شد اما با خطای تنضیمات مواجه شد (نیاز به بررسی رول‌ها) |

**تاریخ اجرا**: 2026-02-05
**اسکریپت**: `scripts/test-phase-4.ts`

---

## اسکریپت‌های کمکی
اسکریپت `scripts/test-phase-4.ts` برای تست این سناریوها استفاده می‌شود.
