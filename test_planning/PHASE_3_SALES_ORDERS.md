# راهنمای تست فاز ۳: فروش و سفارشات (Sales & Orders)

این سند شامل دستورالعمل‌های تست دستی و نتایج تست‌های خودکار برای فرآیند خرید، سبد خرید و ثبت سفارش است.

## پیش‌نیازها
1.  **محصول دارای موجودی**: باید حداقل یک محصول با موجودی مثبت در سیستم باشد (از فاز ۲).
2.  **لاگین (اختیاری)**: سیستم امکان خرید مهمان (Guest) و لاگین‌کرده را دارد. برای تست کامل، هر دو حالت را در نظر بگیرید.

---

## 1. سبد خرید (Shopping Cart)

### الف) افزودن به سبد خرید
**سناریو**: افزودن محصول به سبد خرید.
**روش تست دستی (API)**:
*   **Endpoint**: `POST /api/store/cart`
*   **Headers**: `x-session-id: <random-uuid>` (برای مهمان)
*   **Body**:
    ```json
    {
      "productId": "<PRODUCT_ID>",
      "quantity": 2
    }
    ```
*   **نتیجه**: آیتم به سبد اضافه شود. اگر موجودی کافی نباشد، خطا دهد.

### ب) مشاهده سبد خرید
*   **Endpoint**: `GET /api/store/cart`
*   **Headers**: `x-session-id: <same-uuid>`

---

## 2. ثبت سفارش (Checkout & Order)

### الف) ثبت سفارش جدید
**سناریو**: تبدیل سبد خرید به سفارش نهایی.
**روش تست دستی**:
*   **Endpoint**: `POST /api/store/orders`
*   **Body**:
    ```json
    {
      "customerName": "تست خریدار",
      "customerPhone": "09120000000",
      "paymentMethod": "manual",
      "items": [
        { "productId": "<PRODUCT_ID>", "quantity": 1, "unitPrice": 100000, "productName": "تست" }
      ],
      "shippingAddress": { ... }
    }
    ```
    *(نکته: در پیاده‌سازی سرویس `createOrder`، آیتم‌ها مستقیماً از ورودی گرفته می‌شوند، نه لزوماً از سبد خرید جدول Cart. اما در فرانت‌اند معمولاً دیتای سبد ارسال می‌شود.)*

### ب) کسر موجودی (Stock Deduction)
*   پس از ثبت سفارش موفق:
    1.  موجودی محصول را چک کنید (`GET /api/products/[ID]`).
    2.  باید به اندازه تعداد سفارش داده شده، از موجودی کم شده باشد.

### ج) صدور فاکتور (Invoice)
*   بررسی کنید که در جدول `Invoice` یک رکورد متناظر با سفارش ایجاد شده باشد.

---

## نتایج تست‌های خودکار (Automated Verification Log)

| ردیف | مورد تست | وضعیت | توضیحات |
| :--- | :--- | :--- | :--- |
| 1 | افزودن به سبد خرید | [x] | با موفقیت اضافه شد |
| 2 | آپدیت تعداد در سبد | [x] | اپدیت شد |
| 3 | ثبت سفارش (Create Order) | [x] | شماره سفارش تولید شد |
| 4 | کسر موجودی انبار | [x] | موجودی از ۱۰ به ۷ تغییر کرد |
| 5 | ایجاد خودکار فاکتور | [x] | فاکتور متناظر ایجاد شد |
| 6 | کنسل کردن سفارش (برگشت موجودی) | [x] | موجودی به ۱۰ برگشت |

**تاریخ اجرا**: 2026-02-05
**اسکریپت**: `scripts/test-phase-3.ts`

---

## اسکریپت‌های کمکی
اسکریپت `scripts/test-phase-3.ts` برای تست این سناریوها استفاده می‌شود.
